
{# CTForge: Forge your own CTF. #}

{# Copyright (C) 2016-2020  Marco Squarcina #}
{# Copyright (C) 2016-2020  Mauro Tempesta #}
{# Copyright (C) 2016-2020  Lorenzo Veronese #}

{# This program is free software: you can redistribute it and/or modify #}
{# it under the terms of the GNU Affero General Public License as published #}
{# by the Free Software Foundation, either version 3 of the License, or #}
{# (at your option) any later version. #}

{# This program is distributed in the hope that it will be useful, #}
{# but WITHOUT ANY WARRANTY; without even the implied warranty of #}
{# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the #}
{# GNU Affero General Public License for more details. #}

{# You should have received a copy of the GNU Affero General Public License #}
{# along with this program.  If not, see <https://www.gnu.org/licenses/>. #}

{% extends "layout.html" %}
{% block title %}CTF Scoreboard{% endblock %}
{% block content %}

{% from "_macros.html" import get_status_badge %}

<meta http-equiv="refresh" content="900">

<h1>Scoreboard</h1>
<p>
    {% if rnd > 0 %}
    Scores computed at round <span id="rnd-scores">{{ rnd - 1 }}</span>.
    Current round <span id="rnd-current">{{ rnd }}</span>.
    <span id="countdown-container">
        Next round starting in <span id="countdown"></span>
    </span>
    {% else %}
    Attack/defense CTF is coming soon
    {% endif %}
</p>

<div class="row">
    <div class="col-md-12">
        <table class="table scoreboard"></table>
    </div>
</div>
<div class="row mt-5">
    <div class="col-md-12">
        <div id="global_score" class="chart"></div>
    </div>
</div>

<script>

var seconds_left = {{ time_left }};
var current_round = {{ rnd }};
var update_period = {{ rnd_duration / 20 }};

function formatNumber(n) {
    const prefix = (n >= 0) ? "  " : " ";
    return prefix + n.toLocaleString("en-US", {"minimumFractionDigits": 2, "maximumFractionDigits": 2});
}

function renderTeamName(row) {
    return $("<div>").append($("<div>").addClass("font-weight-bold").text(row.name))
                     .append($("<small>").text(row.ip))
                     .prop("outerHTML");
}

function renderService(serviceName) {
    return function (row) {
        let s = row.services[serviceName];

        let ic;
        if (s.integrity) {
            ic = s.integrity.status ?
                 $("<span class='badge badge-info'>UP</span>") :
                 $("<span class='badge badge-danger'>CORRUPTED</span>");
            ic.attr("title", "last checked at " + s.integrity.timestamp);
        } else {
            ic = $("<span class=\"badge badge-warning\">NOT CHECKED</span>");
        }

        let atk = $("<div title='attack' style='margin-top: 5px'>").append([
             $("<span class='fa fa-lg fa-fire' title='attack'>"),
             formatNumber(s.attack),
             $("<small>").text(' ( '+s.attack_flags).append([
                 " ",
                 $("<span class='fa fa-flag'>"),
                 " )"
             ])
        ]);

        let def = $("<div title='defense'>").append([
             $("<span class='fa fa-lg fa-shield' title='defense'>"),
             formatNumber(s.defense),
             $("<small>").text(' ( '+s.defense_flags).append([
                 " ",
                 $("<span class='fa fa-flag'>"),
                 " )"
             ])
        ]);

        let sla = $("<div title='SLA'>").append([
             $("<span class='fa fa-lg fa-wrench' title='SLA'>"),
             formatNumber(s.sla),
             $("<small>").text(' ( '+(s.sla_percentage | 0)+" % )")
        ]);

        return $("<div>").append([ic, atk, def, sla]).prop("outerHTML");
    }
}

function renderScore(row) {
    let points = $("<div title='global score'>").append([
        $("<span class='fa fa-lg fa-globe' title='global score'>"), $("<span class='global-score'>").append(formatNumber(row.score))
    ]);
    let atk = $("<div title='attack'>").append([
        $("<span class='fa fa-lg fa-fire' title='attack'>"), formatNumber(row.attack)]
    );
    let def = $("<div title='defense'>").append([
        $("<span class='fa fa-lg fa-shield' title='defense'>"), formatNumber(row.defense)
    ]);
    let sla = $("<div title='SLA'>").append([
        $("<span class='fa fa-lg fa-wrench' title='SLA'>"), formatNumber(row.sla)
    ]);
    return $("<div>").append([points, atk, def, sla]).prop("outerHTML");
}

function updateChart() {
    $.getJSON("/ctf_stats/300", function (data) {
        makeChart('global_score', data, scoresChart);
    });
}

function updateCountdown() {
    seconds_left--;
    const s = seconds_left % 3600;
    const hours = Math.floor(seconds_left / 3600);
    const minutes = Math.floor(s / 60);
    const seconds = s % 60;
    $("#countdown").text(hours + " h, " + minutes + " m, " + seconds + " s");
    if (seconds_left < 0) {
        $("#countdown-container").hide();
    } else {
        $("#countdown-container").show();
    }
 }

$(document).ready(function() {

    $('.scoreboard').DataTable({
        "ajax": {
            "url": "/ctf_scoreboard",
            "dataSrc": "scores"
        },
        "columns": [
            { "name": "position", "defaultContent": "", "title": "#", "className": "align-middle text-left counter" },
            { "name": "team", "data": renderTeamName, "title": "Team", "className": "align-middle text-left" },
            {% for s in services %}
            { "name": "services-{{ s.name }}", "data": renderService("{{ s.name }}"),
                "title": "<a href=\"{{ url_for('service', name=s.name) }}\" class=\"btn btn-secondary {% if not s.active %}disabled{% endif %}\" role=\"button\">{{ s.name }}</a>",
                "className": "text-center" },
            {% endfor %}
            { "name": "points", "data": renderScore, "title": "Points", "className": "align-middle text-center" },
        ],
        "ordering": false,
        "paging": false,
        "dom": "t"
    });

    $(".scoreboard").DataTable().on("xhr", (e, settings, json) => {
        current_round = json.round;
        if (seconds_left <= 0) {
            seconds_left = json.seconds_left;
            updateCountdown();
        }
        $("#rnd-scores").text(current_round - 1);
        $("#rnd-current").text(current_round);
    });

    updateCountdown();
    updateChart();
    setInterval(function () {
         if (seconds_left <= 0 || seconds_left % update_period == 0) {
             $('.scoreboard').DataTable().ajax.reload();
         }
         if (seconds_left % (update_period * 10) == 0) {
             updateChart();
         }
         updateCountdown();
    }, 1000);
});
</script>

<script type="text/javascript" src="{{ url_for('static', filename='js/amcharts.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/serial.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/chart_dark.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/amstock.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/ad_charts.js') }}"></script>

{% endblock %}
